# ConfigMaps for SMS Campaign Generation System
apiVersion: v1
kind: ConfigMap
metadata:
  name: app-config
  namespace: sms-campaigns
  labels:
    app: sms-campaigns
    component: config
data:
  production.json: |
    {
      "environment": "production",
      "debug": false,
      "log_level": "INFO",
      "log_format": "json",
      "max_workers": 4,
      "enable_metrics": true,
      "enable_rate_limiting": true,
      "rate_limit_max_requests": 100,
      "rate_limit_time_window": 60,
      "cors_origins": ["https://app.yourdomain.com"],
      "allowed_hosts": ["api.yourdomain.com"],
      "database_pool_size": 20,
      "database_max_overflow": 30,
      "redis_max_connections": 20,
      "openai_model": "gpt-4-turbo-preview",
      "openai_max_tokens": 4000,
      "openai_temperature": 0.7,
      "enable_auto_correction": true,
      "enable_flow_validation": true,
      "validation_timeout_ms": 30000,
      "llm_timeout_ms": 60000
    }
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: monitoring-config
  namespace: sms-campaigns
  labels:
    app: sms-campaigns
    component: monitoring
data:
  prometheus.yml: |
    global:
      scrape_interval: 15s
      evaluation_interval: 15s

    rule_files:
      - "/etc/prometheus/rules/*.yml"

    alerting:
      alertmanagers:
        - static_configs:
            - targets:
              - alertmanager:9093

    scrape_configs:
      - job_name: 'prometheus'
        static_configs:
          - targets: ['localhost:9090']

      - job_name: 'sms-campaigns-app'
        static_configs:
          - targets: ['app:8000']
        metrics_path: '/metrics'
        scrape_interval: 30s
        scrape_timeout: 10s

      - job_name: 'postgres'
        static_configs:
          - targets: ['postgres-exporter:9187']
        scrape_interval: 30s

      - job_name: 'redis'
        static_configs:
          - targets: ['redis-exporter:9121']
        scrape_interval: 30s

      - job_name: 'node-exporter'
        static_configs:
          - targets: ['node-exporter:9100']
        scrape_interval: 30s

      - job_name: 'traefik'
        static_configs:
          - targets: ['traefik:8080']
        scrape_interval: 30s
        metrics_path: '/metrics'

  alert-rules.yml: |
    groups:
    - name: sms-campaigns-alerts
      rules:
      - alert: HighErrorRate
        expr: rate(http_requests_total{status=~"5.."}[5m]) > 0.1
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: High error rate detected
          description: "Error rate is {{ $value }} errors per second"

      - alert: HighResponseTime
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 5
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: High response time detected
          description: "95th percentile response time is {{ $value }} seconds"

      - alert: DatabaseConnectionsHigh
        expr: pg_stat_activity_count > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: High database connections
          description: "Database has {{ $value }} active connections"

      - alert: RedisMemoryHigh
        expr: redis_memory_used_bytes / redis_memory_max_bytes > 0.9
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: Redis memory usage high
          description: "Redis memory usage is {{ $value | humanizePercentage }}"

      - alert: PodCrashLooping
        expr: rate(kube_pod_container_status_restarts_total[15m]) > 0
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: Pod is crash looping
          description: "Pod {{ $labels.pod }} is restarting frequently"

      - alert: HighCPUUsage
        expr: rate(container_cpu_usage_seconds_total[5m]) > 0.8
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: High CPU usage
          description: "CPU usage is {{ $value | humanizePercentage }}"

      - alert: HighMemoryUsage
        expr: container_memory_usage_bytes / container_spec_memory_limit_bytes > 0.9
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: High memory usage
          description: "Memory usage is {{ $value | humanizePercentage }}"

      - alert: DiskSpaceLow
        expr: (node_filesystem_avail_bytes / node_filesystem_size_bytes) < 0.1
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: Low disk space
          description: "Disk space is {{ $value | humanizePercentage }} available"

      - alert: ServiceDown
        expr: up == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: Service is down
          description: "Service {{ $labels.job }} is down"

  grafana-datasources.yml: |
    apiVersion: 1

    datasources:
    - name: Prometheus
      type: prometheus
      access: proxy
      url: http://prometheus:9090
      isDefault: true
      editable: false

    - name: Loki
      type: loki
      access: proxy
      url: http://loki:3100
      editable: false

  grafana-dashboards.yml: |
    apiVersion: 1

    providers:
    - name: 'default'
      orgId: 1
      folder: ''
      type: file
      disableDeletion: false
      updateIntervalSeconds: 10
      allowUiUpdates: true
      options:
        path: /var/lib/grafana/dashboards
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: logging-config
  namespace: sms-campaigns
  labels:
    app: sms-campaigns
    component: logging
data:
  vector.toml: |
    # Vector configuration for log collection and forwarding
    [sources.docker_logs]
      type = docker_logs

    [sources.app_logs]
      type = file
      include = ["/var/log/app/*.log"]
      read_from = "beginning"

    [transforms.parse_app_logs]
      type = "remap"
      inputs = ["app_logs"]
      source = """
        . = parse_json!(.message)
        .timestamp = parse_timestamp!(.timestamp, "%Y-%m-%dT%H:%M:%S%.fZ")
        .service = "sms-campaigns-app"
      """

    [transforms.parse_docker_logs]
      type = "remap"
      inputs = ["docker_logs"]
      source = """
        . = parse_json!(.message)
        .service = .container_name
        .timestamp = parse_timestamp!(.time, "%Y-%m-%dT%H:%M:%S%.fZ")
      """

    [sinks.loki]
      type = "loki"
      inputs = ["parse_app_logs", "parse_docker_logs"]
      endpoint = "http://loki:3100/loki/api/v1/push"
      encoding.codec = "json"

      [sinks.loki.labels]
        service = "{{ service }}"
        environment = "production"

      [sinks.loki.batch]
        max_events = 1000
        timeout_secs = 10

      [sinks.loki.buffer]
        type = "disk"
        max_size = 268435456  # 256MB

    [sinks.stdout]
      type = "console"
      inputs = ["parse_app_logs", "parse_docker_logs"]
      encoding.codec = "json"